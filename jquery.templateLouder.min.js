!function(e){function t(t){var a={Database:null,databaseName:"default",databaseVersion:1,templateRenderCallback:null,selector:"[data-template-src]",debugMode:!1,caching:!0,cacheTime:null,sourceTemplateAttribute:"data-template-src",isRenderedAttribute:"data-template-is-rendered",expiryCacheTimeAttribute:"data-template-expiry",init:function(e){a.log("Initialization TemplateLouder...");for(var t in e)a[t]=e[t];this.isRenderedAttribute||(this.isRenderedAttribute="data-is-rendered-from-sourceTemplateAttribute-"+a.sourceTemplateAttribute),this.caching?a.initDatabase():a.attachOnShowTemplatesEvent()},onShowTemplatePlace:function(t){(!e(t).attr(a.isRenderedAttribute)||a.checkIsExpired(e(t).attr(a.expiryCacheTimeAttribute)))&&(e(t).attr(a.isRenderedAttribute,!0),e(t).attr(a.expiryCacheTimeAttribute,null),a.getTemplateHtml(e(t).attr(a.sourceTemplateAttribute),a.renderTemplate))},attachOnShowTemplatesEvent:function(){e(a.selector).appear(),e(a.selector).on("appear",function(t,n){n.each(function(){a.onShowTemplatePlace(e(this))})}),e(a.selector).on("mouseover",function(){a.onShowTemplatePlace(e(this))}),e(a.selector).on("click",function(){a.onShowTemplatePlace(e(this))}),e(window).scroll()},initDatabase:function(){db.open({server:a.databaseName,version:a.databaseVersion,schema:{templates:{key:{keyPath:"id",autoIncrement:!0},indexes:{source:{unique:!0}}}}}).then(function(e){a.Database=e,a.attachOnShowTemplatesEvent()})},insertTemplateData:function(e){return a.Database?(a.log("Insert new value to indexDB:",e),void a.Database.templates.add(e)):!1},getAjaxTemplate:function(t,n){a.log("Template from ajax, request...",t),e.ajax({type:"GET",url:t,dataType:"html",success:function(e){var r={source:t,html:e,cacheExpiry:null==a.cacheTime?null:(new Date).getTime()+a.cacheTime};a.insertTemplateData(r),n(r)}})},getTemplateHtml:function(e,t){if(a.log("Request for template",e),!a.Database)return a.log("IndexedDB not initialized!"),a.getAjaxTemplate(e,t);var n=new Date;a.Database.templates.query().filter("source",e).execute().then(function(r){var i=new Date;return a.log("Time of indexBD request",i-n),r[0]?(a.log("Template from indexDB",e),r[0].cacheExpiry&&a.checkIsExpired(r[0].cacheExpiry)?(a.deleteItemDatabase(e),a.getAjaxTemplate(e,t)):t(r[0],e)):a.getAjaxTemplate(e,t)})},checkIsExpired:function(e){return e&&new Date(parseInt(e)).getTime()-(new Date).getTime()<0?(a.log("Cache expired"),!0):!1},renderTemplate:function(t){var n=e("["+a.sourceTemplateAttribute+'="'+t.source+'"]');a.log("Rendering template...",t),n.html(t.html),n.attr(a.expiryCacheTimeAttribute,t.cacheExpiry),a.templateRenderCallback&&(a.log("Call of callback after render template..."),a.templateRenderCallback(n))},refresh:function(t){var n=null;n=e(t?t:a.selector),a.log("Refreshing elements...",n),n.attr(this.isRenderedAttribute,null),n.each(function(){var t=e(this).attr(a.sourceTemplateAttribute);a.deleteItemDatabase(t)}),e(window).scroll()},deleteItemDatabase:function(e){return a.log("Database delete item...",e),a.Database?void a.Database.templates.query().filter("source",e).execute().then(function(t){t[0]?(a.Database.remove("templates",t[0].id),a.log("Deleted!",t[0])):a.log("Item not exists in indexDB with key:",e)}):!1},clearDatabase:function(e){a.Database.templates.clear().then(function(){a.log("Database cleared!"),e&&e()})},log:function(){this.debugMode&&console.log(arguments)}};return a.init(t),a}e.fn.extend({templateLouder:function(a){var n={selector:this};return n=e.extend(n,a),new t(n)}})}(jQuery);
